name: BirthdayReminder

on:
  workflow_dispatch:  # 手动触发工作流
  push:
    branches:
      - main  # 指定监控的分支
  pull_request:
    branches:
      - main  # 监控对 main 分支的 PR
  schedule:
    - cron: '20 9 * * *'  # UTC时间每天上午9点20触发

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip -y
          pip3 install lunarcalendar

      - name: Check for birthdays
        id: check_birthdays
        run: |
          import json
          from datetime import datetime, timedelta
          from lunarcalendar import Converter

          # 读取生日数据
          with open('birthdays.json') as f:
              birthdays = json.load(f)

          today = datetime.utcnow().date()
          reminder_days = 3  # 提前提醒天数
          remind_dates = [today + timedelta(days=i) for i in range(reminder_days + 1)]  # 包括今天

          for entry in birthdays:
              name = entry['name']
              birthday = entry['birthday']
              lunar = entry.get('lunar', False)  # 获取是否为农历生日

              # 解析生日
              if lunar:
                  lunar_date = Converter().solar_to_lunar(today.year, int(birthday.split('-')[1]), int(birthday.split('-')[2]))
                  birthday_date = datetime(year=lunar_date.lunar_year, month=lunar_date.lunar_month, day=lunar_date.lunar_day).date()
              else:
                  birthday_date = datetime.strptime(birthday, '%Y-%m-%d').date()

              # 检查是否是今天或提前几天
              if birthday_date in remind_dates:
                  print(f"Sending email for {name}")
                  print(f"name={name}" >> $GITHUB_ENV)
                  print(f"send_email=true" >> $GITHUB_ENV)
                  print(f"recipient=${{ secrets.TO_EMAIL }}" >> $GITHUB_ENV)

      - name: 'Send mail'
        if: env.send_email == 'true'
        uses: dawidd6/action-send-mail@master
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ env.name }} 生日提醒!
          body: |
            <h1>🎉 祝福的时刻又来了！</h1>
            <p>今天是 <strong>${{ env.name }}</strong> 的生日！</p>
            <p>在这个特别的日子里，别忘了送上你最真挚的祝福，让他们感受到你的心意与温暖！</p>
            <p>愿他们的生日充满快乐、爱与惊喜！</p>
          to: ${{ env.recipient }}
          from: GitHub Actions
          content_type: text/html
