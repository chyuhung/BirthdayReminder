name: BirthdayReminder

on:
  workflow_dispatch:  # 手动触发工作流
  push:
    branches:
      - main  # 指定监控的分支
  pull_request:
    branches:
      - main  # 监控对 main 分支的 PR
  schedule:
    - cron: '20 9 * * *'  # UTC时间每天上午9点20触发

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Check for birthdays
        id: check_birthdays
        run: |
          birthdays=$(cat birthdays.json)
          today=$(date +'%Y-%m-%d')
          echo "Birthdays today:"

          for row in $(echo "${birthdays}" | jq -c '.[]'); do
            name=$(echo "${row}" | jq -r '.name')
            birthday=$(echo "${row}" | jq -r '.birthday')
            if [ "$today" == "$birthday" ]; then
              echo "name=$name" >> $GITHUB_ENV
              echo "send_email=true" >> $GITHUB_ENV
              echo "recipient=${{ secrets.TO_EMAIL }}" >> $GITHUB_ENV
            fi
          done

      - name: 'Send mail'
        if: env.send_email == 'true'
        uses: dawidd6/action-send-mail@master
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ env.name }} 生日提醒!
          body: |
            <h1>温馨提示: 今天是 ${{ env.name }}的生日!</h1>
            <p>不要忘记给Ta带去你的诚挚生日快乐祝福!</p>
          to: ${{ env.recipient }}
          from: GitHub Actions
          content_type: text/html
