name: BirthdayReminder

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  push:
    branches:
      - main  # æŒ‡å®šç›‘æ§çš„åˆ†æ”¯
  pull_request:
    branches:
      - main  # ç›‘æ§å¯¹ main åˆ†æ”¯çš„ PR
  schedule:
    - cron: '20 9 * * *'  # UTCæ—¶é—´æ¯å¤©ä¸Šåˆ9ç‚¹20è§¦å‘

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip -y
          pip3 install lunarcalendar

      - name: Create birthday check script
        run: |
          echo 'import json
          from datetime import datetime, timedelta, timezone
          from lunarcalendar import Converter

          # è·å–å½“å‰æ—¶é—´
          today = datetime.now(timezone.utc).date()
          reminder_days = 3  # æå‰æé†’å¤©æ•°
          remind_dates = [today + timedelta(days=i) for i in range(reminder_days + 1)]

          # è¯»å–ç”Ÿæ—¥æ•°æ®
          with open("birthdays.json") as f:
              birthdays = json.load(f)

          for entry in birthdays:
              name = entry["name"]
              birthday = entry["birthday"]
              lunar = entry.get("lunar", False)

              # è§£æç”Ÿæ—¥
              if lunar:
                  # å‡è®¾ä½¿ç”¨ç”Ÿæ—¥çš„é˜³å†å¹´ä»½å’Œæœˆæ—¥æ¥åˆ›å»ºå†œå†å¯¹è±¡
                  lunar_date = Converter().solar_to_lunar(today.year, int(birthday.split("-")[1]), int(birthday.split("-")[2]))
                  birthday_date = datetime(lunar_date.lunar_year, lunar_date.lunar_month, lunar_date.lunar_day).date()
              else:
                  birthday_date = datetime.strptime(birthday, "%Y-%m-%d").date()

              # æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©æˆ–æå‰å‡ å¤©
              if birthday_date in remind_dates:
                  print(f"Sending email for {name}")
                  print(f"name={name}" >> "$GITHUB_ENV")
                  print("send_email=true" >> "$GITHUB_ENV")
                  print(f"recipient=${{ secrets.TO_EMAIL }}" >> "$GITHUB_ENV")
          ' > check_birthdays.py

      - name: Run birthday check script
        run: python3 check_birthdays.py

      - name: 'Send mail'
        if: env.send_email == 'true'
        uses: dawidd6/action-send-mail@master
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ env.name }} ç”Ÿæ—¥æé†’!
          body: |
            <h1>ğŸ‰ ç¥ç¦çš„æ—¶åˆ»åˆæ¥äº†ï¼</h1>
            <p>ä»Šå¤©æ˜¯ <strong>${{ env.name }}</strong> çš„ç”Ÿæ—¥ï¼</p>
            <p>åœ¨è¿™ä¸ªç‰¹åˆ«çš„æ—¥å­é‡Œï¼Œåˆ«å¿˜äº†é€ä¸Šä½ æœ€çœŸæŒšçš„ç¥ç¦ï¼Œè®©ä»–ä»¬æ„Ÿå—åˆ°ä½ çš„å¿ƒæ„ä¸æ¸©æš–ï¼</p>
            <p>æ„¿ä»–ä»¬çš„ç”Ÿæ—¥å……æ»¡å¿«ä¹ã€çˆ±ä¸æƒŠå–œï¼</p>
          to: ${{ env.recipient }}
          from: GitHub Actions
          content_type: text/html
