name: BirthdayReminder

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '20 1 * * *'  # UTCæ—¶é—´å‡Œæ™¨1ç‚¹20åˆ†è§¦å‘ï¼Œå³ä¸œå…«åŒºä¸Šåˆ9ç‚¹20åˆ†

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip -y
          # pip3 install zhdate # ç”±äºé¡¹ç›®ä½œè€…æœªæ¨é€pypiï¼Œä½¿ç”¨æºä»£ç å®‰è£…ä¿®å¤bug
          git clone https://github.com/CutePandaSh/zhdate.git
          cd zhdate
          python3 setup.py install

      - name: Run birthday check script
        id: birthdays
        run: python3 scripts/check_birthdays.py

      - name: Debug outputs
        run: |
          echo "SEND_ADVANCE_EMAIL: ${{ steps.birthdays.outputs.SEND_ADVANCE_EMAIL }}"
          echo "SEND_TODAY_EMAIL: ${{ steps.birthdays.outputs.SEND_TODAY_EMAIL }}"

      - name: 'Send advance mail'
        if: ${{ steps.birthdays.outputs.SEND_ADVANCE_EMAIL == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ steps.birthdays.outputs.ADVANCE_NAMES }} çš„ç”Ÿæ—¥å³å°†åˆ°æ¥ï¼"
          html_body: |
            <div style="font-family: 'Arial', sans-serif; margin: 0 auto; max-width: 600px; background-color: #f0fff0; padding: 25px; border-radius: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.1);">
              <h1 style="color: #4caf50; text-align: center; font-size: 28px; margin-bottom: 20px;">ğŸ‰ ç”Ÿæ—¥å³å°†æ¥ä¸´ ğŸ‰</h1>
              <p style="font-size: 17px; color: #333333; line-height: 1.6; margin-bottom: 15px;">
                ä»¥ä¸‹äº²å‹çš„ç”Ÿæ—¥å°†åœ¨æœªæ¥å‡ å¤©å†…åˆ°æ¥ï¼š<strong style="color: #4caf50;">${{ steps.birthdays.outputs.ADVANCE_NAMES }}</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œç¾çš„æ—¶æœºæ¥è®¡åˆ’å¹¶å‡†å¤‡å¥½ä½ çš„å¿ƒæ„ã€‚
              </p>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 15px;">
                ä¸è®ºæ˜¯ä¸€æ¡æ¸©é¦¨çš„ä¿¡æ¯ï¼Œè¿˜æ˜¯ä¸€ä»½ç‰¹åˆ«çš„ç¤¼ç‰©ï¼Œä½ çš„æå‰å‡†å¤‡éƒ½èƒ½è®©å¯¹æ–¹æ„Ÿå—åˆ°ä½ çš„å…³å¿ƒä¸é‡è§†ã€‚
              </p>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 20px;">
                è®©æˆ‘ä»¬å…±åŒæœŸå¾…ä»–ä»¬çš„æ–°ä¸€å²æ›´åŠ ç²¾å½©ï¼ğŸ‰ğŸˆ
              </p>
              <div style="text-align: center; margin-top: 25px;">
                <a href="mailto:${{ secrets.TO_EMAIL }}" style="background-color: #4caf50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-size: 16px;">
                  ç«‹å³å‘é€ç¥ç¦
                </a>
              </div>
              <p style="text-align: right; font-style: italic; color: #777777; margin-top: 25px;">
                æå‰å‡†å¤‡ï¼Œä¼ é€’æ¸©æš–ã€‚
              </p>
            </div>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions

      - name: 'Send today mail'
        if: ${{ steps.birthdays.outputs.SEND_TODAY_EMAIL == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ä»Šå¤©æ˜¯ ${{ steps.birthdays.outputs.TODAY_NAMES }} çš„ç”Ÿæ—¥ï¼"
          html_body: |
            <div style="font-family: 'Arial', sans-serif; margin: 0 auto; max-width: 600px; background-color: #fff9e5; padding: 25px; border-radius: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.1);">
              <h1 style="color: #ff8c00; text-align: center; font-size: 28px; margin-bottom: 20px;">ğŸ‰ ç”Ÿæ—¥æé†’ ğŸ‰</h1>
              <p style="font-size: 17px; color: #333333; line-height: 1.6; margin-bottom: 15px;">
                ä»Šå¤©æ˜¯ <strong style="color: #ff8c00;">${{ steps.birthdays.outputs.TODAY_NAMES }}</strong> çš„ç”Ÿæ—¥ï¼åˆ«è®©è¿™ä¸ªç‰¹æ®Šçš„æ—¥å­æ‚„ç„¶æºœèµ°ã€‚
              </p>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 15px;">
                è¶ç°åœ¨ï¼Œç»™${{ steps.birthdays.outputs.TODAY_NAMES }}é€å»ä½ è¯šæŒšçš„ç¥ç¦å§ã€‚æ— è®ºæ˜¯ç®€å•çš„é—®å€™è¿˜æ˜¯ç²¾å¿ƒå‡†å¤‡çš„ç¤¼ç‰©ï¼Œä½ çš„ç¥ç¦éƒ½ä¼šä½¿ä»–ä»¬çš„ä¸€å¤©æ›´åŠ ç‰¹åˆ«ã€‚
              </p>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 20px;">
                æ„¿ä»–ä»¬çš„æ–°ä¸€å²å……æ»¡å¿«ä¹ã€å¥åº·ä¸æˆåŠŸï¼ğŸ‰ğŸˆ
              </p>
              <div style="text-align: center; margin-top: 25px;">
                <a href="mailto:${{ secrets.TO_EMAIL }}" style="background-color: #ff8c00; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-size: 16px;">
                  ç«‹å³å‘é€ç¥ç¦
                </a>
              </div>
              <p style="text-align: right; font-style: italic; color: #777777; margin-top: 25px;">
                è®°ä½ï¼Œå°å°çš„å…³æ€€å¯ä»¥å¸¦æ¥å¤§å¤§çš„æ¸©æš–ã€‚
              </p>
            </div>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions