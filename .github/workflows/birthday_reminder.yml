name: BirthdayReminder

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  push:
    branches:
      - main  # æŒ‡å®šç›‘æ§çš„åˆ†æ”¯
  pull_request:
    branches:
      - main  # ç›‘æ§å¯¹ main åˆ†æ”¯çš„ PR
  schedule:
    - cron: '20 1 * * *'  # UTCæ—¶é—´å‡Œæ™¨1ç‚¹20åˆ†è§¦å‘ï¼Œç›¸å½“äºä¸œå…«åŒºä¸Šåˆ9ç‚¹20åˆ†

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip -y
          pip3 install zhdate

      - name: Run birthday check script
        id: birthdays
        run: python3 scripts/check_birthdays.py

      - name: 'Send advance mail'
        if: ${{ steps.birthdays.outputs.SEND_ADVANCE_EMAIL }} == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ä½ çš„äº²å‹ ${{ steps.birthdays.outputs.ADVANCE_NAMES }} çš„ç”Ÿæ—¥å³å°†åˆ°æ¥ï¼"
          html_body: |
            <h1>ğŸ‰ ç”Ÿæ—¥å³å°†åˆ°æ¥ï¼</h1>
            <p>ä»¥ä¸‹äº²å‹çš„ç”Ÿæ—¥å°†åœ¨æœªæ¥å‡ å¤©å†…åˆ°æ¥ï¼š<strong>${{ steps.birthdays.outputs.ADVANCE_NAMES }}</strong></p>
            <p>è¯·å‡†å¤‡å¥½é€ä¸Šä½ æœ€çœŸæŒšçš„ç¥ç¦ã€‚</p>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions

      - name: 'Send today mail'
        if: ${{ steps.birthdays.outputs.SEND_TODAY_EMAIL }} == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[ç”Ÿæ—¥æé†’] ä»Šå¤©æ˜¯ ${{ steps.birthdays.outputs.TODAY_NAMES }} çš„ç”Ÿæ—¥ï¼"
          html_body: |
            <h1>ğŸ‰ ç¥ç¦çš„æ—¶åˆ»æ¥äº†ï¼</h1>
            <p>ä»Šå¤©æ˜¯ <strong>${{ steps.birthdays.outputs.TODAY_NAMES }}</strong> çš„ç”Ÿæ—¥ï¼</p>
            <p>åœ¨è¿™ä¸ªç‰¹åˆ«çš„æ—¥å­é‡Œï¼Œåˆ«å¿˜äº†é€ä¸Šä½ æœ€çœŸæŒšçš„ç¥ç¦ï¼Œè®©ä»–ä»¬æ„Ÿå—åˆ°ä½ çš„å¿ƒæ„ä¸æ¸©æš–ï¼</p>
            <p>æ„¿ä»–ä»¬çš„ç”Ÿæ—¥å……æ»¡å¿«ä¹ã€çˆ±ä¸æƒŠå–œï¼</p>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions