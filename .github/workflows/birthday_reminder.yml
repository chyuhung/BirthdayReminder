name: Birthday Reminder

on:
  schedule:
    - cron: '20 9 * * *'  # UTC时间每天上午9点20触发

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install msmtp
        run: |
          sudo apt-get update
          sudo apt-get install -y msmtp

      - name: Setup msmtp
        run: |
          echo "defaults" > ~/.msmtprc
          echo "account default" >> ~/.msmtprc
          echo "host smtp.exmail.qq.com" >> ~/.msmtprc
          echo "port 465" >> ~/.msmtprc
          echo "auth on" >> ~/.msmtprc
          echo "user ${{ secrets.EMAIL }}" >> ~/.msmtprc
          echo "password ${{ secrets.EMAIL_PASSWORD }}" >> ~/.msmtprc
          echo "from ${{ secrets.EMAIL }}" >> ~/.msmtprc
          echo "logfile ~/.msmtp.log" >> ~/.msmtprc
          chmod 600 ~/.msmtprc

      - name: Check for birthdays
        id: check_birthdays
        run: |
          birthdays=$(cat birthdays.json)
          today=$(date +'%Y-%m-%d')
          echo "Birthdays today:"

          for row in $(echo "${birthdays}" | jq -c '.[]'); do
            name=$(echo "${row}" | jq -r '.name')
            birthday=$(echo "${row}" | jq -r '.birthday')
            if [ "$today" == "$birthday" ]; then
              echo "$name"
              echo "send_email=true" >> $GITHUB_ENV
              echo "recipient=${{ secrets.TO_EMAIL }}" >> $GITHUB_ENV
            fi
          done

      - name: Send email
        if: env.send_email == 'true'
        run: |
          echo "Subject: Happy Birthday!" | msmtp ${{ env.recipient }}
          echo "Happy Birthday, ${{ env.recipient }}!" | msmtp ${{ env.recipient }}
