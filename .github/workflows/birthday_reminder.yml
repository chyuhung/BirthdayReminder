name: BirthdayReminder

on:
  workflow_dispatch:  # 手动触发工作流
  push:
    branches:
      - main  # 指定监控的分支
  pull_request:
    branches:
      - main  # 监控对 main 分支的 PR
  schedule:
    - cron: '20 1 * * *'  # UTC时间凌晨1点20分触发，相当于东八区上午9点20分

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip -y
          pip3 install zhdate

      - name: Run birthday check script
        id: birthdays
        run: python3 scripts/check_birthdays.py

      - name: 'Send advance mail'
        if: ${{ steps.birthdays.outputs.SEND_ADVANCE_EMAIL }} == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "你的亲友 ${{ steps.birthdays.outputs.ADVANCE_NAMES }} 的生日即将到来！"
          html_body: |
            <h1>🎉 生日即将到来！</h1>
            <p>以下亲友的生日将在未来几天内到来：<strong>${{ steps.birthdays.outputs.ADVANCE_NAMES }}</strong></p>
            <p>请准备好送上你最真挚的祝福。</p>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions

      - name: 'Send today mail'
        if: ${{ steps.birthdays.outputs.SEND_TODAY_EMAIL }} == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[生日提醒] 今天是 ${{ steps.birthdays.outputs.TODAY_NAMES }} 的生日！"
          html_body: |
            <h1>🎉 祝福的时刻来了！</h1>
            <p>今天是 <strong>${{ steps.birthdays.outputs.TODAY_NAMES }}</strong> 的生日！</p>
            <p>在这个特别的日子里，别忘了送上你最真挚的祝福，让他们感受到你的心意与温暖！</p>
            <p>愿他们的生日充满快乐、爱与惊喜！</p>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions