name: BirthdayReminder

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '20 0 * * *'  # UTCæ—¶é—´å‡Œæ™¨0ç‚¹20åˆ†è§¦å‘

env:
  BIRTHDAYS_JSON: ${{ secrets.BIRTHDAYS_JSON }}

jobs:
  send_birthday_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip -y
          # pip3 install zhdate # ç”±äºé¡¹ç›®ä½œè€…æœªæ¨é€pypi, ä½¿ç”¨æºä»£ç å®‰è£…ä¿®å¤bug
          git clone https://github.com/CutePandaSh/zhdate.git
          cd zhdate
          pip3 install .

      - name: Run birthday check script
        id: birthdays
        run: python3 scripts/check_birthdays.py

      - name: Debug outputs
        run: |
          echo "BIRTHDAYS_JSON: $BIRTHDAYS_JSON"
          echo "SEND_ADVANCE_EMAIL: ${{ steps.birthdays.outputs.SEND_ADVANCE_EMAIL }}"
          echo "SEND_TODAY_EMAIL: ${{ steps.birthdays.outputs.SEND_TODAY_EMAIL }}"
          echo "SEND_TOMORROW_EMAIL: ${{ steps.birthdays.outputs.SEND_TOMORROW_EMAIL }}"

      - name: 'Send advance mail'
        if: ${{ steps.birthdays.outputs.SEND_ADVANCE_EMAIL == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ steps.birthdays.outputs.REMINDER_DAYS }}å¤©åæ˜¯${{ steps.birthdays.outputs.ADVANCE_NAMES }}çš„ç”Ÿæ—¥"
          html_body: |
            <div style="font-family: 'Arial', sans-serif; margin: 0 auto; max-width: 600px; background-color: #f0fff0; padding: 25px; border-radius: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.1);">
              <h1 style="color: #4caf50; text-align: center; font-size: 28px; margin-bottom: 20px;">ğŸ‰ ç”Ÿæ—¥æå‰æé†’ ğŸ‰</h1>
              <p style="font-size: 17px; color: #333333; line-height: 1.6; margin-bottom: 15px;">
                <strong style="color: #4caf50;">${{ steps.birthdays.outputs.REMINDER_DAYS }}å¤©å</strong>æ˜¯ä»¥ä¸‹äº²å‹çš„ç”Ÿæ—¥ï¼š
              </p>
              <ul style="font-size: 16px; color: #333333; line-height: 1.6; margin-bottom: 15px; padding-left: 20px;">
                ${{ steps.birthdays.outputs.ADVANCE_NAMES.split('ã€').map(name => `<li>${name}</li>`).join('') }}
              </ul>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 15px;">
                ç°åœ¨æ˜¯è®¡åˆ’ç¥ç¦çš„å¥½æ—¶æœºï¼å¯ä»¥å‡†å¤‡ä¸€ä»½ç‰¹åˆ«çš„ç¤¼ç‰©æˆ–æ¸©é¦¨çš„é—®å€™ï¼Œè®©ä»–ä»¬çš„ç”Ÿæ—¥æ›´åŠ éš¾å¿˜ã€‚
              </p>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 20px;">
                æå‰å‡†å¤‡ï¼Œé€ä¸Šæ»¡æ»¡çš„ç¥ç¦ï¼ğŸˆ
              </p>
              <div style="text-align: center; margin-top: 25px;">
                <a href="mailto:" style="background-color: #4caf50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-size: 16px;">
                  å‡†å¤‡ç¥ç¦
                </a>
              </div>
              <p style="text-align: right; font-style: italic; color: #777777; margin-top: 25px;">
                æå‰ç­¹åˆ’ï¼Œæ¸©æš–ç›¸ä¼´
              </p>
            </div>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions

      - name: 'Send tomorrow mail'
        if: ${{ steps.birthdays.outputs.SEND_TOMORROW_EMAIL == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "æ˜å¤©æ˜¯${{ steps.birthdays.outputs.TOMORROW_NAMES }}çš„ç”Ÿæ—¥"
          html_body: |
            <div style="font-family: 'Arial', sans-serif; margin: 0 auto; max-width: 600px; background-color: #e6f3ff; padding: 25px; border-radius: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.1);">
              <h1 style="color: #1e90ff; text-align: center; font-size: 28px; margin-bottom: 20px;">ğŸ‰ æ˜å¤©ç”Ÿæ—¥æé†’ ğŸ‰</h1>
              <p style="font-size: 17px; color: #333333; line-height: 1.6; margin-bottom: 15px;">
                <strong style="color: #1e90ff;">æ˜å¤©</strong>æ˜¯ä»¥ä¸‹äº²å‹çš„ç”Ÿæ—¥ï¼š
              </p>
              <ul style="font-size: 16px; color: #333333; line-height: 1.6; margin-bottom: 15px; padding-left: 20px;">
                ${{ steps.birthdays.outputs.TOMORROW_NAMES.split('ã€').map(name => `<li>${name}</li>`).join('') }}
              </ul>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 15px;">
                æœ€åä¸€å¤©çš„å‡†å¤‡æ—¶é—´ï¼å¿«ä¸ºä»–ä»¬å‡†å¤‡ä¸€ä»½ç‰¹åˆ«çš„ç¥ç¦æˆ–ç¤¼ç‰©ï¼Œè®©ç”Ÿæ—¥å……æ»¡æƒŠå–œã€‚
              </p>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 20px;">
                æ˜å¤©å°†æ˜¯ä»–ä»¬çš„å¤§æ—¥å­ï¼Œé€ä¸Šä½ çš„å¿ƒæ„å§ï¼ğŸˆ
              </p>
              <div style="text-align: center; margin-top: 25px;">
                <a href="mailto:" style="background-color: #1e90ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-size: 16px;">
                  å‡†å¤‡ç¥ç¦
                </a>
              </div>
              <p style="text-align: right; font-style: italic; color: #777777; margin-top: 25px;">
                æå‰ç¥ç¦ï¼Œæ¸©æš–åŠ å€
              </p>
            </div>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions

      - name: 'Send today mail'
        if: ${{ steps.birthdays.outputs.SEND_TODAY_EMAIL == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.exmail.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ä»Šå¤©æ˜¯${{ steps.birthdays.outputs.TODAY_NAMES }}çš„ç”Ÿæ—¥"
          html_body: |
            <div style="font-family: 'Arial', sans-serif; margin: 0 auto; max-width: 600px; background-color: #fff9e5; padding: 25px; border-radius: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.1);">
              <h1 style="color: #ff8c00; text-align: center; font-size: 28px; margin-bottom: 20px;">ğŸ‰ ä»Šå¤©ç”Ÿæ—¥å¿«ä¹ ğŸ‰</h1>
              <p style="font-size: 17px; color: #333333; line-height: 1.6; margin-bottom: 15px;">
                <strong style="color: #ff8c00;">ä»Šå¤©</strong>æ˜¯ä»¥ä¸‹äº²å‹çš„ç”Ÿæ—¥ï¼š
              </p>
              <ul style="font-size: 16px; color: #333333; line-height: 1.6; margin-bottom: 15px; padding-left: 20px;">
                ${{ steps.birthdays.outputs.TODAY_NAMES.split('ã€').map(name => `<li>${name}</li>`).join('') }}
              </ul>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 15px;">
                ä»Šå¤©æ˜¯ä»–ä»¬çš„å¤§æ—¥å­ï¼å¿«é€ä¸Šä½ çš„ç¥ç¦ï¼Œæ— è®ºæ˜¯æ¸©é¦¨çš„é—®å€™è¿˜æ˜¯ç‰¹åˆ«çš„ç¤¼ç‰©ï¼Œéƒ½ä¼šè®©è¿™ä¸€å¤©æ›´åŠ éš¾å¿˜ã€‚
              </p>
              <p style="font-size: 16px; color: #555555; line-height: 1.6; margin-bottom: 20px;">
                æ„¿ä»–ä»¬çš„ç”Ÿæ—¥å……æ»¡æ¬¢ä¹ã€æ¸©æš–ä¸å¹¸ç¦ï¼ğŸˆ
              </p>
              <div style="text-align: center; margin-top: 25px;">
                <a href="mailto:" style="background-color: #ff8c00; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-size: 16px;">
                  å‘é€ç¥ç¦
                </a>
              </div>
              <p style="text-align: right; font-style: italic; color: #777777; margin-top: 25px;">
                ç”Ÿæ—¥å½“å¤©ï¼Œç¥ç¦æœ€çœŸ
              </p>
            </div>
          to: ${{ secrets.TO_EMAIL }}
          from: GitHub Actions
